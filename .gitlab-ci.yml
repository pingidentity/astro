stages:
  - build-ci-image
  - test
  - backstop


build_ci_image:
  stage: build-ci-image
  # This was causing issues where some builds would fail to find the proper Docker hash.
  # It should be added back in at some point.
  only:
    changes:
      - Dockerfile
  script:
    - docker build --pull --tag docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.0 ./shared/docker
    - docker push docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.0
  tags:
    - platform-publish-docker

test:
  stage: test
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.0
  script:
    - yarn global add lerna
    - lerna bootstrap
    - lerna run lint
    - lerna run coverage-ci
    - lerna run pack

backstop:
  stage: backstop
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.0
  script:
    - yarn global add lerna
    - lerna bootstrap
    - lerna run backstop-ci