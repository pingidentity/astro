stages:
  - build-ci-image
  - pack
  - test

# This has to be done before each script because Gitlab's caching can fail in a
# number of circumstances.
# before_script:
#   - lerna bootstrap

build_ci_image:
  stage: build-ci-image
  # This was causing issues where some builds would fail to find the proper Docker hash.
  # It should be added back in at some point.
  only:
    changes:
      - Dockerfile
  script:
    - docker build --pull --tag docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1 ./shared/docker
    - docker push docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1
  tags:
    - platform-publish-docker


# Do this as a separate stage to make sure everything builds
pack:
  stage: pack
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1
  script:
    - lerna bootstrap
    # Building this on its own for now because it doesn't have its own pack command.
    - lerna run build --scope @pingux/charting
    - lerna run pack
    - lerna run dist --scope @pingux/end-user
    - lerna link
    - lerna run dist --scope @pingux/schema-form
  artifacts:
    paths:
      - ./packages/ui-library/build
      - ./packages/end-user/dist
      - ./packages/schema-forms/dist

lint:
  stage: test
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1
  script:
    - lerna bootstrap
    - lerna link
    - lerna run lint

coverage:
  stage: test
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1
  script:
    - lerna bootstrap
    - lerna link
    - lerna run coverage-ci

backstop:
  stage: test
  tags:
    - platform-build-docker
  image: docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1
  script:
    - lerna bootstrap
    - lerna run backstop-ci