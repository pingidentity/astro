variables:
  STABLE_IMAGE: "docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.1"
  LATEST_IMAGE: "docker.corp.pingidentity.com:5000/testing/pingux-latest:1.1"

stages:
  - build-ci-image
  - build-test-lint
  - screenshot

.yarn-install-and-build: &yarn-install-and-build
  before_script:
    - yarn --frozen-lockfile

# This has to be done before each script because Gitlab's caching can fail in a
# number of circumstances.
# before_script:
#   - lerna bootstrap

# NOTE: Make and test changes to the "latest" image _before_ merging them to the stable one. Otherwise, all
# pipelines will be impacted because they use the stable image for running scripts.
build_ci_stable_image:
  stage: build-ci-image
  # This was causing issues where some builds would fail to find the proper Docker hash.
  # It should be added back in at some point.
  only:
    changes:
      - shared/docker/stable/Dockerfile
  script:
    - docker build --pull --tag "$STABLE_IMAGE" ./shared/docker/stable
    - docker push "$STABLE_IMAGE"
  tags:
    - eks-platform-publish-docker

build_ci_latest_image:
  stage: build-ci-image
  # This was causing issues where some builds would fail to find the proper Docker hash.
  # It should be added back in at some point.
  only:
    changes:
      - shared/docker/latest/Dockerfile
  script:
    - docker build --pull --tag "$LATEST_IMAGE" ./shared/docker/latest
    - docker push "$LATEST_IMAGE"
  tags:
    - eks-platform-publish-docker

# Do this as a separate stage to make sure everything builds
build:
  <<: *yarn-install-and-build
  stage: build-test-lint
  tags:
    - default-gitlab-runner
  image: $STABLE_IMAGE
  only:
    - merge_requests
  script:
    - echo "$CI_MERGE_REQUEST_TITLE" | npx commitlint
    - lerna run build
    - lerna run lint
    - lerna run coverage-ci
  artifacts:
    paths:
      - ./packages/**/lib


backstop:
  <<: *yarn-install-and-build
  stage: screenshot
  tags:
    - default-gitlab-runner
  image: $STABLE_IMAGE
  only:
    refs:
      - merge_requests
    changes:
      - packages/ui-library/*
  script:
    - lerna run demo --scope ui-library
    - lerna run backstop-ci

chromatic:
  <<: *yarn-install-and-build
  stage: screenshot
  tags:
    - platform-build-docker
  image: $STABLE_IMAGE
  only:
      refs:
        - merge_requests
      changes:
        - packages/astro/*

  script:
    - lerna run chromatic -- --project-token=$CHROMATIC_PROJECT_TOKEN --build-script-name demo --exit-zero-on-changes --scope astro
