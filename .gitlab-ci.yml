include:
  - local: .gitlab-ci/build-ci-image.yml
  - local: .gitlab-ci/build-test-lint-all.yml
  - local: .gitlab-ci/build-test-lint-packages.yml
  - local: .gitlab-ci/commit-lint.yml
  - local: .gitlab-ci/deploy.yml
  - local: .gitlab-ci/test-screenshot.yml

# NOTE: The numerical suffix in the image string refers to the version of the docker image
# this number will need to be incremented (i.e. 1.1 to 1.2), when changes to a package
# require a new docker image to be consistently pulled.
variables:
  KUBERNETES_MEMORY_LIMIT: "6250Mi"
  KUBERNETES_MEMORY_REQUEST: "125Mi"
  GITHUB_IMAGE: "docker.corp.pingidentity.com:5000/testing/astro-github:1.0.1"
  LATEST_IMAGE: "docker.corp.pingidentity.com:5000/testing/pingux-latest:1.4.2"
  STABLE_IMAGE: "docker.corp.pingidentity.com:5000/testing/ui-library-admin:1.4.1"

stages:
  - build-ci-image
  - setup
  - build-test-lint
  - screenshot
  - deploy

.base-job:
  stage: build-test-lint
  tags:
    - pingux-runner-s3-cache
  image: $STABLE_IMAGE
  interruptible: true
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - .yarn/unplugged
    policy: pull


yarn-install:
  extends: 
    - .base-job
  stage: setup
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - yarn.lock
    # Run automatically for all commits on develop and master
    - if: '$CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'
  script: 
    - yarn install
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - .yarn/unplugged
    policy: push
    untracked: true